theory hillel_challenge_FulcrumNoOverflow_fulcrumqtvc
  imports "NTP4Verif.NTP4Verif" "Why3STD.Ref_Ref" "Why3STD.int_Sum"
begin
typedecl  big
consts q :: "big \<Rightarrow> 32 word"
consts r :: "big \<Rightarrow> 32 word"
consts v :: "big \<Rightarrow> int"
axiomatization where big'invariant'0:   "-((2147483647 :: int) + (1 :: int)) \<le> sint (q self)"
  for self :: "big"
axiomatization where big'invariant'1:   "sint (q self) \<le> (2147483647 :: int) + (1 :: int) - (1 :: int)"
  for self :: "big"
axiomatization where big'invariant'2:   "(0 :: int) \<le> sint (r self)"
  for self :: "big"
axiomatization where big'invariant'3:   "sint (r self) \<le> (2147483647 :: int) + (1 :: int) - (1 :: int)"
  for self :: "big"
axiomatization where big'invariant'4:   "v self = sint (q self) * ((2147483647 :: int) + (1 :: int)) + sint (r self)"
  for self :: "big"
definition big'eq :: "big \<Rightarrow> big \<Rightarrow> _"
  where "big'eq a b \<longleftrightarrow> q a = q b \<and> r a = r b \<and> v a = v b" for a b
axiomatization where big'inj:   "a = b"
 if "big'eq a b"
  for a :: "big"
  and b :: "big"
consts big_zero :: "unit \<Rightarrow> big"
axiomatization where big_zero'def'0:   "q (big_zero x) = (0 :: 32 word)"
  for x :: "unit"
axiomatization where big_zero'def'1:   "r (big_zero x) = (0 :: 32 word)"
  for x :: "unit"
axiomatization where big_zero'def'2:   "v (big_zero x) = (0 :: int)"
  for x :: "unit"
consts fc :: "32 word array32 \<Rightarrow> int \<Rightarrow> int"
axiomatization where fc'def:   "fc a i = sint (array32_elts a i)"
  for a :: "32 word array32"
  and i :: "int"
definition sum :: "32 word array32 \<Rightarrow> int \<Rightarrow> int \<Rightarrow> int"
  where "sum a l u = int_Sum.sum (fc a) l u" for a l u
definition diff :: "32 word array32 \<Rightarrow> int \<Rightarrow> int"
  where "diff a i = abs (sum a (0 :: int) i - sum a i (sint (array32_length a)))" for a i
theorem fulcrum'vc:
  fixes a :: "32 word array32"
  assumes fact0: "sint (array32_length a) < sint (2147483647 :: 32 word)"
  shows "let n :: 32 word = array32_length a; right1 :: big = big_zero () in int'32_in_bounds (sint n - (1 :: int)) \<and> (\<forall>(o1 :: 32 word). sint o1 = sint n - (1 :: int) \<longrightarrow> ((0 :: int) \<le> sint o1 + (1 :: int) \<longrightarrow> ((55 :: int) < (89 :: int) \<and> v right1 = sum a (0 :: int) (0 :: int)) \<and> (\<forall>(right2 :: big). (\<forall>(i :: 32 word). let i1 :: int = sint i in ((0 :: int) \<le> i1 \<and> i1 \<le> sint o1) \<and> (55 :: int) < (89 :: int) \<and> v right2 = sum a (0 :: int) i1 \<longrightarrow> ((0 :: int) \<le> sint i \<and> sint i < sint (array32_length a)) \<and> (let o2 :: 32 word = array32_elts a (sint i) in (-((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) \<le> v right2 + sint o2 \<and> v right2 + sint o2 \<le> ((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) - (1 :: int)) \<and> (\<forall>(right3 :: big). v right3 = v right2 + sint o2 \<longrightarrow> (55 :: int) < (89 :: int) \<and> v right3 = sum a (0 :: int) (i1 + (1 :: int))))) \<and> ((55 :: int) < (89 :: int) \<and> v right2 = sum a (0 :: int) (sint o1 + (1 :: int)) \<longrightarrow> (let left1 :: big = big_zero () in (-((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) \<le> abs (v left1 - v right2) \<and> abs (v left1 - v right2) \<le> ((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) - (1 :: int)) \<and> (\<forall>(bestd :: big). v bestd = abs (v left1 - v right2) \<longrightarrow> int'32_in_bounds (sint n - (1 :: int)) \<and> (\<forall>(o2 :: 32 word). sint o2 = sint n - (1 :: int) \<longrightarrow> ((0 :: int) \<le> sint o2 + (1 :: int) \<longrightarrow> ((55 :: int) < (89 :: int) \<and> v left1 = sum a (0 :: int) (0 :: int) \<and> v right2 = sum a (0 :: int) (sint n) \<and> (0 :: int) \<le> (0 :: int) \<and> v bestd = diff a (0 :: int) \<and> (\<forall>(j :: int). (0 :: int) \<le> j \<and> j \<le> (0 :: int) \<longrightarrow> v bestd \<le> diff a j)) \<and> (\<forall>(bestd1 :: big) (besti :: 32 word) (left2 :: big) (right3 :: big). (\<forall>(i :: 32 word). let i1 :: int = sint i in ((0 :: int) \<le> i1 \<and> i1 \<le> sint o2) \<and> (55 :: int) < (89 :: int) \<and> v left2 = sum a (0 :: int) i1 \<and> v right3 = sum a i1 (sint n) \<and> ((0 :: int) \<le> sint besti \<and> sint besti \<le> i1) \<and> v bestd1 = diff a (sint besti) \<and> (\<forall>(j :: int). (0 :: int) \<le> j \<and> j \<le> i1 \<longrightarrow> v bestd1 \<le> diff a j) \<longrightarrow> ((0 :: int) \<le> sint i \<and> sint i < sint (array32_length a)) \<and> (let o3 :: 32 word = array32_elts a (sint i) in (-((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) \<le> v left2 + sint o3 \<and> v left2 + sint o3 \<le> ((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) - (1 :: int)) \<and> (\<forall>(left3 :: big). v left3 = v left2 + sint o3 \<longrightarrow> ((0 :: int) \<le> sint i \<and> sint i < sint (array32_length a)) \<and> (let o4 :: 32 word = array32_elts a (sint i) in (-((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) \<le> v right3 - sint o4 \<and> v right3 - sint o4 \<le> ((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) - (1 :: int)) \<and> (\<forall>(right4 :: big). v right4 = v right3 - sint o4 \<longrightarrow> (-((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) \<le> abs (v left3 - v right4) \<and> abs (v left3 - v right4) \<le> ((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) - (1 :: int)) \<and> (\<forall>(d :: big). v d = abs (v left3 - v right4) \<longrightarrow> ((0 :: int) \<le> v d \<and> (0 :: int) \<le> v bestd1) \<and> (if v d < v bestd1 then \<forall>(bestd2 :: big). int'32_in_bounds (sint i + (1 :: int)) \<and> (\<forall>(o5 :: 32 word). sint o5 = sint i + (1 :: int) \<longrightarrow> ((-((2147483647 :: int) + (1 :: int)) \<le> sint (q d) \<and> sint (q d) \<le> (2147483647 :: int) + (1 :: int) - (1 :: int)) \<and> ((0 :: int) \<le> sint (r d) \<and> sint (r d) \<le> (2147483647 :: int) + (1 :: int) - (1 :: int)) \<and> v d = sint (q d) * ((2147483647 :: int) + (1 :: int)) + sint (r d)) \<and> (v d = v bestd2 \<and> r d = r bestd2 \<and> q d = q bestd2 \<longrightarrow> (55 :: int) < (89 :: int) \<and> v left3 = sum a (0 :: int) (i1 + (1 :: int)) \<and> v right4 = sum a (i1 + (1 :: int)) (sint n) \<and> ((0 :: int) \<le> sint o5 \<and> sint o5 \<le> i1 + (1 :: int)) \<and> v bestd2 = diff a (sint o5) \<and> (\<forall>(j :: int). (0 :: int) \<le> j \<and> j \<le> i1 + (1 :: int) \<longrightarrow> v bestd2 \<le> diff a j))) else (55 :: int) < (89 :: int) \<and> v left3 = sum a (0 :: int) (i1 + (1 :: int)) \<and> v right4 = sum a (i1 + (1 :: int)) (sint n) \<and> ((0 :: int) \<le> sint besti \<and> sint besti \<le> i1 + (1 :: int)) \<and> v bestd1 = diff a (sint besti) \<and> (\<forall>(j :: int). (0 :: int) \<le> j \<and> j \<le> i1 + (1 :: int) \<longrightarrow> v bestd1 \<le> diff a j)))))))) \<and> ((55 :: int) < (89 :: int) \<and> v left2 = sum a (0 :: int) (sint o2 + (1 :: int)) \<and> v right3 = sum a (sint o2 + (1 :: int)) (sint n) \<and> ((0 :: int) \<le> sint besti \<and> sint besti \<le> sint o2 + (1 :: int)) \<and> v bestd1 = diff a (sint besti) \<and> (\<forall>(j :: int). (0 :: int) \<le> j \<and> j \<le> sint o2 + (1 :: int) \<longrightarrow> v bestd1 \<le> diff a j) \<longrightarrow> ((0 :: int) \<le> sint besti \<and> sint besti \<le> sint (array32_length a)) \<and> (\<forall>(i :: int). (0 :: int) \<le> i \<and> i \<le> sint (array32_length a) \<longrightarrow> diff a (sint besti) \<le> diff a i)))) \<and> (sint o2 + (1 :: int) < (0 :: int) \<longrightarrow> ((0 :: int) \<le> (0 :: int) \<and> (0 :: int) \<le> sint (array32_length a)) \<and> (\<forall>(i :: int). (0 :: int) \<le> i \<and> i \<le> sint (array32_length a) \<longrightarrow> diff a (0 :: int) \<le> diff a i)))))))) \<and> (sint o1 + (1 :: int) < (0 :: int) \<longrightarrow> (let left1 :: big = big_zero () in (-((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) \<le> abs (v left1 - v right1) \<and> abs (v left1 - v right1) \<le> ((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) - (1 :: int)) \<and> (\<forall>(bestd :: big). v bestd = abs (v left1 - v right1) \<longrightarrow> int'32_in_bounds (sint n - (1 :: int)) \<and> (\<forall>(o2 :: 32 word). sint o2 = sint n - (1 :: int) \<longrightarrow> ((0 :: int) \<le> sint o2 + (1 :: int) \<longrightarrow> ((55 :: int) < (89 :: int) \<and> v left1 = sum a (0 :: int) (0 :: int) \<and> v right1 = sum a (0 :: int) (sint n) \<and> (0 :: int) \<le> (0 :: int) \<and> v bestd = diff a (0 :: int) \<and> (\<forall>(j :: int). (0 :: int) \<le> j \<and> j \<le> (0 :: int) \<longrightarrow> v bestd \<le> diff a j)) \<and> (\<forall>(bestd1 :: big) (besti :: 32 word) (left2 :: big) (right2 :: big). (\<forall>(i :: 32 word). let i1 :: int = sint i in ((0 :: int) \<le> i1 \<and> i1 \<le> sint o2) \<and> (55 :: int) < (89 :: int) \<and> v left2 = sum a (0 :: int) i1 \<and> v right2 = sum a i1 (sint n) \<and> ((0 :: int) \<le> sint besti \<and> sint besti \<le> i1) \<and> v bestd1 = diff a (sint besti) \<and> (\<forall>(j :: int). (0 :: int) \<le> j \<and> j \<le> i1 \<longrightarrow> v bestd1 \<le> diff a j) \<longrightarrow> ((0 :: int) \<le> sint i \<and> sint i < sint (array32_length a)) \<and> (let o3 :: 32 word = array32_elts a (sint i) in (-((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) \<le> v left2 + sint o3 \<and> v left2 + sint o3 \<le> ((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) - (1 :: int)) \<and> (\<forall>(left3 :: big). v left3 = v left2 + sint o3 \<longrightarrow> ((0 :: int) \<le> sint i \<and> sint i < sint (array32_length a)) \<and> (let o4 :: 32 word = array32_elts a (sint i) in (-((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) \<le> v right2 - sint o4 \<and> v right2 - sint o4 \<le> ((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) - (1 :: int)) \<and> (\<forall>(right3 :: big). v right3 = v right2 - sint o4 \<longrightarrow> (-((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) \<le> abs (v left3 - v right3) \<and> abs (v left3 - v right3) \<le> ((2147483647 :: int) + (1 :: int)) * ((2147483647 :: int) + (1 :: int)) - (1 :: int)) \<and> (\<forall>(d :: big). v d = abs (v left3 - v right3) \<longrightarrow> ((0 :: int) \<le> v d \<and> (0 :: int) \<le> v bestd1) \<and> (if v d < v bestd1 then \<forall>(bestd2 :: big). int'32_in_bounds (sint i + (1 :: int)) \<and> (\<forall>(o5 :: 32 word). sint o5 = sint i + (1 :: int) \<longrightarrow> ((-((2147483647 :: int) + (1 :: int)) \<le> sint (q d) \<and> sint (q d) \<le> (2147483647 :: int) + (1 :: int) - (1 :: int)) \<and> ((0 :: int) \<le> sint (r d) \<and> sint (r d) \<le> (2147483647 :: int) + (1 :: int) - (1 :: int)) \<and> v d = sint (q d) * ((2147483647 :: int) + (1 :: int)) + sint (r d)) \<and> (v d = v bestd2 \<and> r d = r bestd2 \<and> q d = q bestd2 \<longrightarrow> (55 :: int) < (89 :: int) \<and> v left3 = sum a (0 :: int) (i1 + (1 :: int)) \<and> v right3 = sum a (i1 + (1 :: int)) (sint n) \<and> ((0 :: int) \<le> sint o5 \<and> sint o5 \<le> i1 + (1 :: int)) \<and> v bestd2 = diff a (sint o5) \<and> (\<forall>(j :: int). (0 :: int) \<le> j \<and> j \<le> i1 + (1 :: int) \<longrightarrow> v bestd2 \<le> diff a j))) else (55 :: int) < (89 :: int) \<and> v left3 = sum a (0 :: int) (i1 + (1 :: int)) \<and> v right3 = sum a (i1 + (1 :: int)) (sint n) \<and> ((0 :: int) \<le> sint besti \<and> sint besti \<le> i1 + (1 :: int)) \<and> v bestd1 = diff a (sint besti) \<and> (\<forall>(j :: int). (0 :: int) \<le> j \<and> j \<le> i1 + (1 :: int) \<longrightarrow> v bestd1 \<le> diff a j)))))))) \<and> ((55 :: int) < (89 :: int) \<and> v left2 = sum a (0 :: int) (sint o2 + (1 :: int)) \<and> v right2 = sum a (sint o2 + (1 :: int)) (sint n) \<and> ((0 :: int) \<le> sint besti \<and> sint besti \<le> sint o2 + (1 :: int)) \<and> v bestd1 = diff a (sint besti) \<and> (\<forall>(j :: int). (0 :: int) \<le> j \<and> j \<le> sint o2 + (1 :: int) \<longrightarrow> v bestd1 \<le> diff a j) \<longrightarrow> ((0 :: int) \<le> sint besti \<and> sint besti \<le> sint (array32_length a)) \<and> (\<forall>(i :: int). (0 :: int) \<le> i \<and> i \<le> sint (array32_length a) \<longrightarrow> diff a (sint besti) \<le> diff a i)))) \<and> (sint o2 + (1 :: int) < (0 :: int) \<longrightarrow> ((0 :: int) \<le> (0 :: int) \<and> (0 :: int) \<le> sint (array32_length a)) \<and> (\<forall>(i :: int). (0 :: int) \<le> i \<and> i \<le> sint (array32_length a) \<longrightarrow> diff a (0 :: int) \<le> diff a i)))))))"
  sorry
end

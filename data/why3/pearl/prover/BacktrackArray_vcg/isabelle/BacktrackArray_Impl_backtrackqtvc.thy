theory BacktrackArray_Impl_backtrackqtvc
  imports "NTP4Verif.NTP4Verif" "../../lib/isabelle/BacktrackArray_Types" "../../lib/isabelle/Functions_Config" "../../lib/isabelle/Functions_Func" "../../lib/isabelle/Predicates_Pred" "../../lib/isabelle/BacktrackArray_Logic" "../../lib/isabelle/Choice_Choice"
begin
theorem backtrack'vc:
  fixes t :: "'a timestamp"
  fixes tb :: "'a t"
  assumes fact0: "past_time t tb"
  assumes fact1: "correct tb"
  shows "let final_size :: int = BacktrackArray_Types.size t; o1 :: 'a list list = buffer tb in \<forall>(o2 :: 'a list list). length o2 = length o1 \<and> (\<forall>(i :: int). (0 :: int) \<le> i \<and> i < int (length o2) \<longrightarrow> o2 ! nat i = o1 ! nat i) \<longrightarrow> (let tbc :: 'a t = t'mk (history tb) (current_time tb) o2 (inv tb) in (\<forall>(tbc1 :: 'a t) (tb1 :: 'a t). inv tbc1 = inv tb \<longrightarrow> inv tb1 = inv tb \<longrightarrow> (\<forall>(delta :: int). correct tbc1 \<and> past_time t tbc1 \<and> (0 :: int) \<le> delta \<and> current_time tbc1 = time t + delta \<and> (history tbc1 = history tb1 \<and> (\<forall>(x :: int). ((0 :: int) \<le> x \<and> x < final_size) \<and> x < int (length (buffer tbc1)) \<longrightarrow> func_of_array (buffer tbc1) (Nil :: 'a list) x = func_of_array (buffer tb1) (Nil :: 'a list) x)) \<and> int (length (buffer tb1)) \<le> final_size \<longrightarrow> (if \<not>delta = (0 :: int) then case history tb1 of Nil \<Rightarrow> False | Cons x q \<Rightarrow> (\<forall>(tb2 :: 'a t). history tb2 = q \<and> current_time tb2 = current_time tb1 \<and> buffer tb2 = buffer tb1 \<and> inv tb2 = inv tb1 \<longrightarrow> (\<forall>(tbc2 :: 'a t). history tbc2 = q \<and> current_time tbc2 = current_time tbc1 \<and> buffer tbc2 = buffer tbc1 \<and> inv tbc2 = inv tbc1 \<longrightarrow> (\<forall>(tbc3 :: 'a t). history tbc3 = history tbc2 \<and> current_time tbc3 = current_time tbc2 - (1 :: int) \<and> buffer tbc3 = buffer tbc2 \<and> inv tbc3 = inv tbc2 \<longrightarrow> (if x = -(1 :: int) then let buf1 :: 'a list list = buffer tbc3 in \<not>(2 :: int) = (0 :: int) \<and> (let len2 :: int = int (length buf1) cdiv (2 :: int) in (0 :: int) \<le> len2 \<and> (\<forall>(buf2 :: 'a list list). (\<forall>(i :: int). (0 :: int) \<le> i \<and> i < len2 \<longrightarrow> buf2 ! nat i = (Nil :: 'a list)) \<and> int (length buf2) = len2 \<longrightarrow> (((0 :: int) \<le> (0 :: int) \<and> (0 :: int) \<le> len2 \<and> (0 :: int) + len2 \<le> int (length buf1)) \<and> (0 :: int) \<le> (0 :: int) \<and> (0 :: int) + len2 \<le> int (length buf2)) \<and> (\<forall>(buf21 :: 'a list list). length buf21 = length buf2 \<longrightarrow> (\<forall>(i :: int). (0 :: int) \<le> i \<and> i < (0 :: int) \<or> (0 :: int) + len2 \<le> i \<and> i < int (length buf21) \<longrightarrow> buf21 ! nat i = buf2 ! nat i) \<and> (\<forall>(i :: int). (0 :: int) \<le> i \<and> i < (0 :: int) + len2 \<longrightarrow> buf21 ! nat i = buf1 ! nat ((0 :: int) + i - (0 :: int))) \<longrightarrow> (\<forall>(tbc4 :: 'a t). history tbc4 = history tbc3 \<and> current_time tbc4 = current_time tbc3 \<and> buffer tbc4 = buf21 \<and> inv tbc4 = inv tbc3 \<longrightarrow> (let o3 :: int = delta - (1 :: int) in (((0 :: int) \<le> delta \<and> o3 < delta) \<and> correct tbc4 \<and> past_time t tbc4 \<and> (0 :: int) \<le> o3 \<and> current_time tbc4 = time t + o3 \<and> (history tbc4 = history tb2 \<and> (\<forall>(x1 :: int). ((0 :: int) \<le> x1 \<and> x1 < final_size) \<and> x1 < int (length (buffer tbc4)) \<longrightarrow> func_of_array (buffer tbc4) (Nil :: 'a list) x1 = func_of_array (buffer tb2) (Nil :: 'a list) x1)) \<and> int (length (buffer tb2)) \<le> final_size) \<and> (\<forall>(tbc5 :: 'a t) (tb3 :: 'a t). inv tbc5 = inv tbc4 \<longrightarrow> current_time tb3 = current_time tb2 \<and> length (buffer tb3) = length (buffer tb2) \<and> inv tb3 = inv tb2 \<longrightarrow> correct tbc5 \<and> (history tbc5 = history tb3 \<and> (\<forall>(x1 :: int). (0 :: int) \<le> x1 \<and> x1 < final_size \<longrightarrow> func_of_array (buffer tbc5) (Nil :: 'a list) x1 = func_of_array (buffer tb3) (Nil :: 'a list) x1)) \<and> current_timestamp tbc5 = t \<and> length (buffer tbc5) \<le> length (buffer tbc4) \<and> precede tbc5 tbc4 \<and> (\<forall>(t2 :: 'a timestamp). before t2 t \<and> past_time t2 tbc4 \<longrightarrow> past_time t2 tbc5) \<longrightarrow> correct tbc5 \<and> (history tbc5 = history tb3 \<and> (\<forall>(x1 :: int). (0 :: int) \<le> x1 \<and> x1 < final_size \<longrightarrow> func_of_array (buffer tbc5) (Nil :: 'a list) x1 = func_of_array (buffer tb3) (Nil :: 'a list) x1)) \<and> current_timestamp tbc5 = t \<and> length (buffer tbc5) \<le> length (buffer tbc1) \<and> precede tbc5 tbc1 \<and> (\<forall>(t2 :: 'a timestamp). before t2 t \<and> past_time t2 tbc1 \<longrightarrow> past_time t2 tbc5))))))) else if x < final_size then let o3 :: 'a list list = buffer tb2 in ((0 :: int) \<le> x \<and> x < int (length o3)) \<and> (case o3 ! nat x of (Nil :: 'a list) \<Rightarrow> False | Cons _ q1 \<Rightarrow> (let o4 :: 'a list list = buffer tb2 in ((0 :: int) \<le> x \<and> x < int (length o4)) \<and> (\<forall>(tb3 :: 'a t). let o5 :: 'a list list = buffer tb3 in length (buffer tb3) = length o4 \<longrightarrow> tb3 = t'mk (history tb2) (current_time tb2) (buffer tb3) (inv tb2) \<and> length (buffer tb3) = length (buffer tb2) \<longrightarrow> nth o5 o nat = (nth o4 o nat)(x := q1) \<and> o5 = o4[nat x := q1] \<longrightarrow> (let o6 :: 'a list list = buffer tbc3 in ((0 :: int) \<le> x \<and> x < int (length o6)) \<and> (\<forall>(tbc4 :: 'a t). let o7 :: 'a list list = buffer tbc4 in length (buffer tbc4) = length o6 \<longrightarrow> tbc4 = t'mk (history tbc3) (current_time tbc3) (buffer tbc4) (inv tbc3) \<and> length (buffer tbc4) = length (buffer tbc3) \<longrightarrow> nth o7 o nat = (nth o6 o nat)(x := q1) \<and> o7 = o6[nat x := q1] \<longrightarrow> (let o8 :: int = delta - (1 :: int) in (((0 :: int) \<le> delta \<and> o8 < delta) \<and> correct tbc4 \<and> past_time t tbc4 \<and> (0 :: int) \<le> o8 \<and> current_time tbc4 = time t + o8 \<and> (history tbc4 = history tb3 \<and> (\<forall>(x1 :: int). ((0 :: int) \<le> x1 \<and> x1 < final_size) \<and> x1 < int (length (buffer tbc4)) \<longrightarrow> func_of_array (buffer tbc4) (Nil :: 'a list) x1 = func_of_array (buffer tb3) (Nil :: 'a list) x1)) \<and> int (length (buffer tb3)) \<le> final_size) \<and> (\<forall>(tbc5 :: 'a t) (tb4 :: 'a t). inv tbc5 = inv tbc4 \<longrightarrow> current_time tb4 = current_time tb3 \<and> length (buffer tb4) = length (buffer tb3) \<and> inv tb4 = inv tb3 \<longrightarrow> correct tbc5 \<and> (history tbc5 = history tb4 \<and> (\<forall>(x1 :: int). (0 :: int) \<le> x1 \<and> x1 < final_size \<longrightarrow> func_of_array (buffer tbc5) (Nil :: 'a list) x1 = func_of_array (buffer tb4) (Nil :: 'a list) x1)) \<and> current_timestamp tbc5 = t \<and> length (buffer tbc5) \<le> length (buffer tbc4) \<and> precede tbc5 tbc4 \<and> (\<forall>(t2 :: 'a timestamp). before t2 t \<and> past_time t2 tbc4 \<longrightarrow> past_time t2 tbc5) \<longrightarrow> correct tbc5 \<and> (history tbc5 = history tb4 \<and> (\<forall>(x1 :: int). (0 :: int) \<le> x1 \<and> x1 < final_size \<longrightarrow> func_of_array (buffer tbc5) (Nil :: 'a list) x1 = func_of_array (buffer tb4) (Nil :: 'a list) x1)) \<and> current_timestamp tbc5 = t \<and> length (buffer tbc5) \<le> length (buffer tbc1) \<and> precede tbc5 tbc1 \<and> (\<forall>(t2 :: 'a timestamp). before t2 t \<and> past_time t2 tbc1 \<longrightarrow> past_time t2 tbc5)))))))) else let o3 :: 'a list list = buffer tbc3 in ((0 :: int) \<le> x \<and> x < int (length o3)) \<and> (case o3 ! nat x of (Nil :: 'a list) \<Rightarrow> False | Cons _ q1 \<Rightarrow> (let o4 :: 'a list list = buffer tbc3 in ((0 :: int) \<le> x \<and> x < int (length o4)) \<and> (\<forall>(tbc4 :: 'a t). let o5 :: 'a list list = buffer tbc4 in length (buffer tbc4) = length o4 \<longrightarrow> tbc4 = t'mk (history tbc3) (current_time tbc3) (buffer tbc4) (inv tbc3) \<and> length (buffer tbc4) = length (buffer tbc3) \<longrightarrow> nth o5 o nat = (nth o4 o nat)(x := q1) \<and> o5 = o4[nat x := q1] \<longrightarrow> (let o6 :: int = delta - (1 :: int) in (((0 :: int) \<le> delta \<and> o6 < delta) \<and> correct tbc4 \<and> past_time t tbc4 \<and> (0 :: int) \<le> o6 \<and> current_time tbc4 = time t + o6 \<and> (history tbc4 = history tb2 \<and> (\<forall>(x1 :: int). ((0 :: int) \<le> x1 \<and> x1 < final_size) \<and> x1 < int (length (buffer tbc4)) \<longrightarrow> func_of_array (buffer tbc4) (Nil :: 'a list) x1 = func_of_array (buffer tb2) (Nil :: 'a list) x1)) \<and> int (length (buffer tb2)) \<le> final_size) \<and> (\<forall>(tbc5 :: 'a t) (tb3 :: 'a t). inv tbc5 = inv tbc4 \<longrightarrow> current_time tb3 = current_time tb2 \<and> length (buffer tb3) = length (buffer tb2) \<and> inv tb3 = inv tb2 \<longrightarrow> correct tbc5 \<and> (history tbc5 = history tb3 \<and> (\<forall>(x1 :: int). (0 :: int) \<le> x1 \<and> x1 < final_size \<longrightarrow> func_of_array (buffer tbc5) (Nil :: 'a list) x1 = func_of_array (buffer tb3) (Nil :: 'a list) x1)) \<and> current_timestamp tbc5 = t \<and> length (buffer tbc5) \<le> length (buffer tbc4) \<and> precede tbc5 tbc4 \<and> (\<forall>(t2 :: 'a timestamp). before t2 t \<and> past_time t2 tbc4 \<longrightarrow> past_time t2 tbc5) \<longrightarrow> correct tbc5 \<and> (history tbc5 = history tb3 \<and> (\<forall>(x1 :: int). (0 :: int) \<le> x1 \<and> x1 < final_size \<longrightarrow> func_of_array (buffer tbc5) (Nil :: 'a list) x1 = func_of_array (buffer tb3) (Nil :: 'a list) x1)) \<and> current_timestamp tbc5 = t \<and> length (buffer tbc5) \<le> length (buffer tbc1) \<and> precede tbc5 tbc1 \<and> (\<forall>(t2 :: 'a timestamp). before t2 t \<and> past_time t2 tbc1 \<longrightarrow> past_time t2 tbc5)))))))))) else correct tbc1 \<and> (history tbc1 = history tb1 \<and> (\<forall>(x :: int). (0 :: int) \<le> x \<and> x < final_size \<longrightarrow> func_of_array (buffer tbc1) (Nil :: 'a list) x = func_of_array (buffer tb1) (Nil :: 'a list) x)) \<and> current_timestamp tbc1 = t \<and> length (buffer tbc1) \<le> length (buffer tbc1) \<and> precede tbc1 tbc1 \<and> (\<forall>(t2 :: 'a timestamp). before t2 t \<and> past_time t2 tbc1 \<longrightarrow> past_time t2 tbc1)))) \<and> (if final_size < int (length (buffer tb)) then (0 :: int) \<le> final_size \<and> (\<forall>(buf2 :: 'a list list). (\<forall>(i :: int). (0 :: int) \<le> i \<and> i < final_size \<longrightarrow> buf2 ! nat i = (Nil :: 'a list)) \<and> int (length buf2) = final_size \<longrightarrow> (let buf1 :: 'a list list = buffer tb in (((0 :: int) \<le> (0 :: int) \<and> (0 :: int) \<le> final_size \<and> (0 :: int) + final_size \<le> int (length buf1)) \<and> (0 :: int) \<le> (0 :: int) \<and> (0 :: int) + final_size \<le> int (length buf2)) \<and> (\<forall>(buf21 :: 'a list list). length buf21 = length buf2 \<longrightarrow> (\<forall>(i :: int). (0 :: int) \<le> i \<and> i < (0 :: int) \<or> (0 :: int) + final_size \<le> i \<and> i < int (length buf21) \<longrightarrow> buf21 ! nat i = buf2 ! nat i) \<and> (\<forall>(i :: int). (0 :: int) \<le> i \<and> i < (0 :: int) + final_size \<longrightarrow> buf21 ! nat i = buf1 ! nat ((0 :: int) + i - (0 :: int))) \<longrightarrow> (\<forall>(tb1 :: 'a t). history tb1 = history tb \<and> current_time tb1 = current_time tb \<and> buffer tb1 = buf21 \<and> inv tb1 = inv tb \<longrightarrow> (\<forall>(tb2 :: 'a t). history tb2 = history tb1 \<and> current_time tb2 = time t \<and> buffer tb2 = buffer tb1 \<and> inv tb2 = inv tb1 \<longrightarrow> (let o3 :: int = current_time tb1 - time t in (correct tbc \<and> past_time t tbc \<and> (0 :: int) \<le> o3 \<and> current_time tb = time t + o3 \<and> (history tb = history tb2 \<and> (\<forall>(x :: int). ((0 :: int) \<le> x \<and> x < final_size) \<and> x < int (length o2) \<longrightarrow> func_of_array o2 (Nil :: 'a list) x = func_of_array (buffer tb2) (Nil :: 'a list) x)) \<and> int (length (buffer tb2)) \<le> final_size) \<and> (\<forall>(tbc1 :: 'a t) (tb3 :: 'a t). inv tbc1 = inv tb \<longrightarrow> current_time tb3 = current_time tb2 \<and> length (buffer tb3) = length (buffer tb2) \<and> inv tb3 = inv tb2 \<longrightarrow> correct tbc1 \<and> (history tbc1 = history tb3 \<and> (\<forall>(x :: int). (0 :: int) \<le> x \<and> x < final_size \<longrightarrow> func_of_array (buffer tbc1) (Nil :: 'a list) x = func_of_array (buffer tb3) (Nil :: 'a list) x)) \<and> current_timestamp tbc1 = t \<and> length (buffer tbc1) \<le> length o2 \<and> precede tbc1 tbc \<and> (\<forall>(t2 :: 'a timestamp). before t2 t \<and> past_time t2 tbc \<longrightarrow> past_time t2 tbc1) \<longrightarrow> correct tb3 \<and> current_timestamp tb3 = t \<and> past_time (current_timestamp tb3) tb3 \<and> (\<forall>(t2 :: 'a timestamp). before t2 t \<and> past_time t2 tb \<longrightarrow> past_time t2 tb3) \<and> precede tb3 tb))))))) else \<forall>(tb1 :: 'a t). history tb1 = history tb \<and> current_time tb1 = time t \<and> buffer tb1 = buffer tb \<and> inv tb1 = inv tb \<longrightarrow> (let o3 :: int = current_time tb - time t in (correct tbc \<and> past_time t tbc \<and> (0 :: int) \<le> o3 \<and> current_time tb = time t + o3 \<and> (history tb = history tb1 \<and> (\<forall>(x :: int). ((0 :: int) \<le> x \<and> x < final_size) \<and> x < int (length o2) \<longrightarrow> func_of_array o2 (Nil :: 'a list) x = func_of_array (buffer tb1) (Nil :: 'a list) x)) \<and> int (length (buffer tb1)) \<le> final_size) \<and> (\<forall>(tbc1 :: 'a t) (tb2 :: 'a t). inv tbc1 = inv tb \<longrightarrow> current_time tb2 = current_time tb1 \<and> length (buffer tb2) = length (buffer tb1) \<and> inv tb2 = inv tb1 \<longrightarrow> correct tbc1 \<and> (history tbc1 = history tb2 \<and> (\<forall>(x :: int). (0 :: int) \<le> x \<and> x < final_size \<longrightarrow> func_of_array (buffer tbc1) (Nil :: 'a list) x = func_of_array (buffer tb2) (Nil :: 'a list) x)) \<and> current_timestamp tbc1 = t \<and> length (buffer tbc1) \<le> length o2 \<and> precede tbc1 tbc \<and> (\<forall>(t2 :: 'a timestamp). before t2 t \<and> past_time t2 tbc \<longrightarrow> past_time t2 tbc1) \<longrightarrow> correct tb2 \<and> current_timestamp tb2 = t \<and> past_time (current_timestamp tb2) tb2 \<and> (\<forall>(t2 :: 'a timestamp). before t2 t \<and> past_time t2 tb \<longrightarrow> past_time t2 tb2) \<and> precede tb2 tb))))"
  sorry
end
